name: Android Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Sync Capacitor
      run: npx cap sync

    - name: Make gradlew executable
      run: chmod +x android/gradlew

    - name: Get version info
      id: version
      run: |
        cd android
        VERSION_NAME=$(grep "versionName" app/build.gradle | sed 's/.*versionName[[:space:]]*"\([^"]*\)".*/\1/')
        VERSION_CODE=$(grep "versionCode" app/build.gradle | sed 's/.*versionCode[[:space:]]*\([0-9]*\).*/\1/')
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT

    - name: Get commit info
      id: commit
      run: |
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT

    - name: Create keystore from secret
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore

    - name: Create keystore properties
      run: |
        cat > android/keystore.properties << EOF
        storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
        keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
        storeFile=release.keystore
        EOF

    - name: Build signed APK
      run: |
        cd android
        ./gradlew assembleRelease

    - name: Rename APK
      run: |
        VERSION_NAME="${{ steps.version.outputs.version_name }}"
        VERSION_CODE="${{ steps.version.outputs.version_code }}"
        COMMIT_SHORT="${{ steps.commit.outputs.commit_short }}"
        APK_NAME="Caffeine-Tracker-${VERSION_NAME}(${VERSION_CODE})-${COMMIT_SHORT}.apk"
        mv android/app/build/outputs/apk/release/app-release.apk "$APK_NAME"
        echo "APK_NAME=$APK_NAME" >> $GITHUB_ENV

    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APK_NAME }}
        path: ${{ env.APK_NAME }}

    - name: Install WebDAV client
      run: |
        sudo apt-get update
        sudo apt-get install -y curl

    - name: Ensure versions folder exists on WebDAV
      run: |
        curl -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
          -X MKCOL "${{ secrets.WEBDAV_URL }}/versions" || true

    - name: Clean old versions from WebDAV (in /versions/)
      run: |
        VERSION_NAME="${{ steps.version.outputs.version_name }}"
        curl -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
          -X PROPFIND \
          -H "Depth: 1" \
          -H "Content-Type: text/xml" \
          --data '<?xml version="1.0"?><propfind xmlns="DAV:"><prop><displayname/></prop></propfind>' \
          "${{ secrets.WEBDAV_URL }}/versions" \
          -s | grep -oP "Caffeine-Tracker-${VERSION_NAME}[^<]*\\.apk" | while read file; do
          echo "Deleting old version: $file"
          curl -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
            -X DELETE \
            "${{ secrets.WEBDAV_URL }}/versions/$file" \
            -w "HTTP Status: %{http_code}\n" || echo "Failed to delete $file"
        done

    - name: Upload versioned APK to WebDAV (in /versions/)
      run: |
        curl -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
          -T "${{ env.APK_NAME }}" \
          "${{ secrets.WEBDAV_URL }}/versions/${{ env.APK_NAME }}" \
          -w "HTTP Status: %{http_code}\n"

    - name: Upload release APK to WebDAV (root dir)
      run: |
        cp "${{ env.APK_NAME }}" "Caffeine-Tracker-release.apk"
        curl -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
          -T "Caffeine-Tracker-release.apk" \
          "${{ secrets.WEBDAV_URL }}/Caffeine-Tracker-release.apk" \
          -w "HTTP Status: %{http_code}\n"

    - name: Clean up sensitive files
      if: always()
      run: |
        rm -f android/app/release.keystore
        rm -f android/keystore.properties